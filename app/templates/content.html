{% extends "base.html" %}

{% block css %}
    {{ super() }}
    <style>
        #regions_div {
            margin: auto;
        }
        .title {
            text-align: center;
          	font-size: 15px;
            text-transform: uppercase;
            color: #2C3E50;
            margin: 2rem;
        }

        .main {
            font-weight: bold;
            margin-top: 2rem;
            font-size: 30px;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        line {
            stroke: #3FA7D6;
            opacity: 1;
        }

        #limit line {
            stroke-width: 3;
            stroke-dasharray: 3;
        }
        .cards {
          display: flex;
          justify-content: center;
          align-items: center;
          flex-wrap: wrap;
          margin: 10px auto;
          max-width: 1200px;
        }

      .card {
        width: 300px;
        max-width: 300px;
        margin: 12px;
        padding: 1.5rem;
        color: #fff;
        border-radius: 5px;
        box-shadow: 7px 6px 26px -17px rgba(0, 0, 0, 1);
        cursor: pointer;
        transition: 0.3s all;
      }

        h3 {
          font-size: 29px;
        }
        p {
          font-size: 20px;
        }

    .confirmed {
      background-color: #3498db;
    }
    .deaths {
      background-color: #e74c3c;
    }
    .recovered {
      background-color: #2ecc71;
    }

    .confirmed:hover, .deaths:hover, .recovered:hover {
      transform: translateY(-4px);
    }

    .twisted {
        display: flex;
        flex-direction: row;
    }


    </style>
{% endblock %}

{% block content %}
    {{ super() }}
    <h1 class="title main">Coronavirus Dashboard</h1>
    <div class="cards">
        <div class="card confirmed">
          <h3 id="cases">Confirmed</h3>
          <p>{{ context.latest.confirmed }}</p>
        </div>
        <div class="card deaths">
          <h3 id="deaths">Deaths</h3>
          <p>{{ context.latest.deaths }}</p>
        </div>
        <div class="card recovered">
          <h3 id="recovered">Recovered</h3>
          <p>{{ context.latest.recovered }}</p>
        </div>
      </div>

    <h2 class="title">Confirmed cases around the world:</h2>
    <div id="regions_div" style="width: 900px; height: 500px;"></div>

    <div class="twisted">
        <div id="curve_chart" style="width: 900px; height: 500px"></div>
        <div id="piechart" style="width: 900px; height: 500px;"></div>
    </div>

    <svg id="graph-container"></svg>
{% endblock %}

{% block js %}
    {{ super() }}
    <script>
        google.charts.load('current', {
            'packages': ['geochart', 'corechart'],
            // Note: you will need to get a mapsApiKey for your project.
            // See: https://developers.google.com/chart/interactive/docs/basic_load_libs#load-settings
            'mapsApiKey': 'AIzaSyD-9tSrke72PouQMnMX-a7eZSW0jkFMBWY'
        });
        google.charts.setOnLoadCallback(drawRegionsMap);
        google.charts.setOnLoadCallback(drawLineChart);
        google.charts.setOnLoadCallback(drawPieChart);

        const covid_data = JSON.parse('{{ context|tojson }}');

        function drawRegionsMap() {
            let temp = [
                ['Country', 'Confirmed', 'Deaths']
            ]

            for (let country in covid_data['locations']) {
                temp.push([covid_data['locations'][country]['code'], covid_data['locations'][country]['confirmed']['latest'], covid_data['locations'][country]['deaths']['latest']]);
            }

            var data = google.visualization.arrayToDataTable(temp);

            var options = {
                colorAxis: {
                    maxValue: 250000,
                    colors: ['#57bb8a', '#73b87e', '#94bd77', '#b0be6e', '#d4c86a', '#f5ce62', '#e9b861', '#ecac67', '#e9a268', '#e5926b', '#e0816d', '#dd776e']
                },
                backgroundColor: '#81d4fa',
                defaultColor: '#f5f5f5',
            };

            var chart = new google.visualization.GeoChart(document.getElementById('regions_div'));

            chart.draw(data, options);
        }

        function drawLineChart() {

            let temp = []

            for (let date in covid_data['locations']['Afghanistan']['confirmed']['history']) {
                let current = 0;
                for (let country in covid_data['locations']) {
                    current += covid_data['locations'][country]['confirmed']['history'][date] - (covid_data['locations'][country]['deaths']['history'][date] + covid_data['locations'][country]['recovered']['history'][date]);
                }
                let date_formated = date.split('/')
                let day = date_formated[1]
                let month = date_formated[0]
                let year = "20" + date_formated[2]
                date_formated = year + '-' + month + '-' + day
                temp.push([new Date(date_formated), current])
            }

            function compare(a, b) {
                if (a[0] < b[0])
                    return -1;
                if (a[0] > b[0])
                    return 1;
                return 0;
            }

            temp.sort(compare)

            temp.unshift(['Date', 'Currently Infected'])

            var data = google.visualization.arrayToDataTable(temp);

            var options = {
                title: 'Active cases (Worldwide)',
                curveType: 'function',
                legend: {position: 'bottom'},
                vAxis: {
                    viewWindow: {
                        min: 0
                    }
                }
            }

            var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

            chart.draw(data, options);
        }

        function drawPieChart() {
            let temp = [['Country', 'Confirmed cases']];

            for(let country in covid_data['locations']){
                temp.push([country, covid_data['locations'][country]['confirmed']['latest']])
            }

            function compare(a, b) {
                if (a[1] > b[1])
                    return -1;
                if (a[1] < b[1])
                    return 1;
                return 0;
            }
            temp.sort(compare)

            var data = google.visualization.arrayToDataTable(temp);

            var options = {
                title: 'Current infection repartition'
            };

            var chart = new google.visualization.PieChart(document.getElementById('piechart'));

            chart.draw(data, options);
        }

        function drawsvg() {
            const margin = 100;
            const width = window.innerWidth - 2 * margin
            const height = window.innerHeight - 2 * margin;
            const svg = d3.select("#graph-container")
                .attr("width", width + 2 * margin)
                .attr("height", height + 2 * margin);
            const chart = svg.append('g')
                .attr("transform", "translate(" + margin + "," + margin + ")");
            const xScale = d3.scaleBand()
                .range([0, width])
                .domain(Object.keys(covid_data.locations))
                .padding(0.1);
            const yScale = d3.scaleLinear()
                .range([height, 0])
                .domain([0, covid_data.latest.deaths]);
            chart.append('g')
                .call(d3.axisLeft(yScale))
            chart.append('g')
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("y", 0)
                .attr("x", 9)
                .attr("dy", ".35em")
                .attr("transform", "rotate(90)")
                .style("text-anchor", "start");
            chart.append('g')
                .attr('class', 'grid')
                .call(d3.axisLeft()
                    .scale(yScale)
                    .tickSize(-width, 0, 0)
                    .tickFormat(''))
            svg
                .append('text')
                .attr('class', 'label')
                .attr('x', -(height / 2) - margin)
                .attr('y', margin / 2.4)
                .attr('transform', 'rotate(-90)')
                .attr('text-anchor', 'middle')
                .text('Deaths')
                .attr('stroke', 'black')
            svg.append('text')
                .attr('class', 'label')
                .attr('x', width / 2 + margin)
                .attr('y', height + margin * 1.8)
                .text('Country')
                .attr('stroke', 'black')
            svg.append('text')
                .attr('class', 'title')
                .attr('x', width / 2 + margin)
                .attr('y', 90)
                .text('Deaths per country')
                .attr('stroke', '#2C3E50')
            const barGroups = chart.selectAll()
                .data(covid_data.locations)
                .enter()
                {#.append('g')#}
                {#.attr('class', 'barContainer')#}
                {#barGroups#}
                .append('rect')
                .attr('class', 'bar')
                {#.style("fill", (_, i) => `rgb(${i * 20}, ${Math.round(i * 20 / 2)}, 200)`)#}
                .style("fill", "steelblue")
                {#.transition()#}
                {#.duration(200)#}
                {#.delay((d, i) => i * 70)#}
                .attr('x', function (d) {
                    return xScale(d.name);
                })
                .attr('x', function (d) {
                    return yScale(d.deaths.latest);
                })
                .attr('height', (s) => height - Math.round(yScale(s.deaths.latest)))
                .attr('width', xScale.bandwidth())
        }

        drawsvg()

    </script>

{% endblock %}